<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Firebase Migration Tool</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-100 min-h-screen p-6">
  <div class="max-w-2xl mx-auto">
    <h1 class="text-2xl font-bold text-slate-800 mb-6">Firebase Migration Tool</h1>

    <!-- Step 1: Export from GAS -->
    <div class="bg-white rounded-xl shadow p-4 mb-4">
      <h2 class="font-bold text-slate-700 mb-2">Step 1: GASからエクスポート</h2>
      <p class="text-sm text-slate-600 mb-3">
        GASエディタで <code class="bg-slate-100 px-1 rounded">exportForFirebase</code> を実行し、
        ログに出力されたJSONをコピーしてください。
      </p>
      <p class="text-sm text-slate-600">
        または、デプロイURLに <code class="bg-slate-100 px-1 rounded">?type=export</code> を追加してアクセス。
      </p>
    </div>

    <!-- Step 2: Paste JSON -->
    <div class="bg-white rounded-xl shadow p-4 mb-4">
      <h2 class="font-bold text-slate-700 mb-2">Step 2: JSONを貼り付け</h2>
      <textarea id="json-input"
        class="w-full h-48 p-3 border rounded-lg font-mono text-sm resize-none"
        placeholder='{"members": [...], "notices": [...]}'></textarea>
      <button onclick="parseJson()"
        class="mt-3 bg-slate-800 text-white px-4 py-2 rounded hover:bg-slate-700">
        JSONを解析
      </button>
    </div>

    <!-- Step 3: Preview & Import -->
    <div id="preview-section" class="hidden">
      <div class="bg-white rounded-xl shadow p-4 mb-4">
        <h2 class="font-bold text-slate-700 mb-2">Step 3: プレビュー</h2>
        <div id="preview" class="text-sm text-slate-600 space-y-1"></div>
      </div>

      <div class="bg-white rounded-xl shadow p-4 mb-4">
        <h2 class="font-bold text-slate-700 mb-2">Step 4: Firestoreにインポート</h2>
        <div class="flex gap-3">
          <button onclick="importMembers()"
            class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-500">
            Membersをインポート
          </button>
          <button onclick="importNotices()"
            class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-500">
            Noticesをインポート
          </button>
          <button onclick="importAll()"
            class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-500">
            全てインポート
          </button>
        </div>
      </div>

      <div id="log-section" class="bg-slate-800 rounded-xl p-4 text-green-400 font-mono text-sm h-48 overflow-y-auto">
        <div id="log"></div>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="firebase.js"></script>

  <script>
    let parsedData = null;

    function log(msg) {
      const el = document.getElementById("log");
      const time = new Date().toLocaleTimeString();
      el.innerHTML += `<div>[${time}] ${msg}</div>`;
      el.parentElement.scrollTop = el.parentElement.scrollHeight;
    }

    function parseJson() {
      const input = document.getElementById("json-input").value.trim();
      try {
        parsedData = JSON.parse(input);

        const membersCount = parsedData.members?.length || 0;
        const noticesCount = parsedData.notices?.length || 0;

        document.getElementById("preview").innerHTML = `
          <p><strong>Members:</strong> ${membersCount}件</p>
          <p><strong>Notices:</strong> ${noticesCount}件</p>
          ${membersCount > 0 ? `<p class="text-xs text-slate-400">Members例: ${parsedData.members[0].id} - ${parsedData.members[0].name}</p>` : ""}
          ${noticesCount > 0 ? `<p class="text-xs text-slate-400">Notices例: ${parsedData.notices[0].title}</p>` : ""}
        `;

        document.getElementById("preview-section").classList.remove("hidden");
        log(`JSON解析完了: Members ${membersCount}件, Notices ${noticesCount}件`);
      } catch (e) {
        alert("JSONの解析に失敗しました: " + e.message);
      }
    }

    async function importMembers() {
      if (!parsedData?.members?.length) {
        log("Membersデータがありません");
        return;
      }

      log(`Members インポート開始 (${parsedData.members.length}件)...`);

      let success = 0;
      let failed = 0;

      for (const member of parsedData.members) {
        try {
          const id = String(member.id);
          if (!id) {
            failed++;
            continue;
          }

          const docData = {
            name: member.name || "",
            grade: member.grade || "",
            part: member.part || "",
            status: member.status || "",
            comment: member.comment || "",
            pass: String(member.pass || "").padStart(4, "0"),
            createdAt: member.createdAt ? new Date(member.createdAt) : firebase.firestore.FieldValue.serverTimestamp(),
            updatedAt: member.updatedAt ? new Date(member.updatedAt) : firebase.firestore.FieldValue.serverTimestamp()
          };

          await db.collection("members").doc(id).set(docData);
          success++;
          log(`  [OK] ${id} - ${docData.name}`);
        } catch (e) {
          failed++;
          log(`  [NG] ${member.id}: ${e.message}`);
        }
      }

      log(`Members インポート完了: 成功 ${success}件, 失敗 ${failed}件`);
    }

    async function importNotices() {
      if (!parsedData?.notices?.length) {
        log("Noticesデータがありません");
        return;
      }

      log(`Notices インポート開始 (${parsedData.notices.length}件)...`);

      let success = 0;
      let failed = 0;

      for (const notice of parsedData.notices) {
        try {
          const docData = {
            title: notice.title || "",
            body: notice.body || "",
            isActive: !!notice.isActive,
            isImportant: !!notice.isImportant,
            createdAt: notice.createdAt ? new Date(notice.createdAt) : firebase.firestore.FieldValue.serverTimestamp()
          };

          // 元のIDがあればそれを使用、なければ自動生成
          if (notice.id) {
            await db.collection("notices").doc(String(notice.id)).set(docData);
          } else {
            await db.collection("notices").add(docData);
          }

          success++;
          log(`  [OK] ${notice.title}`);
        } catch (e) {
          failed++;
          log(`  [NG] ${notice.title}: ${e.message}`);
        }
      }

      log(`Notices インポート完了: 成功 ${success}件, 失敗 ${failed}件`);
    }

    async function importAll() {
      await importMembers();
      await importNotices();
      log("=== 全てのインポートが完了しました ===");
    }
  </script>
</body>
</html>
