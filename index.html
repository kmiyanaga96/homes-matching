<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ほーむずマッチング</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta property="og:type" content="website">
    <meta property="og:title" content="ほーむずマッチング">
    <meta property="og:description" content="バンドメンバー探しアプリ">
    <meta property="og:image" content="https://kmiyanaga96.github.io/homes-matching/homes-logo.png">
    <meta property="og:url" content="https://kmiyanaga96.github.io/homes-matching/">
    <meta name="twitter:card" content="summary">

    <style>
        body { overscroll-behavior-y: contain; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fadeIn { animation: fadeIn 0.3s ease-out forwards; }
        .heart-pop { animation: heartPop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes heartPop {
            0% { transform: scale(1); }
            50% { transform: scale(1.4); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen pb-24 text-slate-900">

    <header class="bg-[#d9f99d] text-slate-700 p-5 shadow-sm sticky top-0 z-20 border-b border-[#bef264]">
        <h1 class="text-xl font-bold text-center tracking-tight">ほーむずマッチング</h1>
    </header>

    <main id="app" class="p-4 max-w-md mx-auto">
        <div class="mb-6 space-y-3">
            <div class="relative">
                <input type="text" id="search-name" placeholder="名前やコメントで検索..." 
                    class="w-full p-4 pr-10 rounded-2xl border-none shadow-sm focus:ring-2 focus:ring-[#bef264] outline-none text-gray-700 text-base placeholder-gray-400">
                <button id="clear-btn" class="hidden absolute right-3 top-1/2 -translate-y-1/2 text-gray-300 hover:text-gray-500">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
            
            <div class="flex space-x-2 overflow-x-auto pb-1 scrollbar-hide">
                <button id="filter-fav" class="bg-white border border-transparent shadow-sm rounded-xl px-4 py-2 text-sm font-medium outline-none text-gray-400 whitespace-nowrap transition-all">
                    ❤️ お気に入り
                </button>
                <select id="filter-grade" class="bg-white border-none shadow-sm rounded-xl px-4 py-2 text-sm font-medium outline-none text-gray-500 focus:ring-2 focus:ring-[#bef264]">
                    <option value="">すべての学年</option>
                    <option value="1">1年</option><option value="2">2年</option><option value="3">3年</option><option value="4">4年</option><option value="卒業生">卒業生</option>
                </select>
                <select id="filter-part" class="bg-white border-none shadow-sm rounded-xl px-4 py-2 text-sm font-medium outline-none text-gray-500 focus:ring-2 focus:ring-[#bef264]">
                    <option value="">すべてのパート</option>
                    <option value="Gt">Gt</option><option value="Ba">Ba</option><option value="Dr">Dr</option><option value="Vo">Vo</option><option value="Key">Key</option>
                </select>
                <select id="filter-status" class="bg-white border-none shadow-sm rounded-xl px-4 py-2 text-sm font-medium outline-none text-gray-500 focus:ring-2 focus:ring-[#bef264]">
                    <option value="">すべての状態</option>
                    <option value="ミニライブ">ミニライブ</option><option value="定期ライブ">定期ライブ</option><option value="合宿">合宿</option><option value="非公式ライブ">非公式ライブ</option><option value="DMして">DMして</option><option value="むり">むり</option>
                </select>
            </div>
        </div>

        <div id="loading" class="text-center py-20 text-gray-400 font-medium">
            <div class="animate-spin inline-block w-6 h-6 border-[3px] border-current border-t-transparent text-[#bef264] rounded-full mb-2"></div>
            <p>読み込み中...</p>
        </div>
        <div id="pull-indicator" class="flex flex-col items-center justify-center h-0 overflow-hidden transition-all duration-200 text-[#bef264]">
            <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-current"></div>
            <span class="text-[10px] font-bold mt-1 uppercase tracking-widest">Updating</span>
        </div>

        <div id="member-list" class="grid gap-4"></div>
    </main>

    <div id="detail-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm" onclick="closeModal()"></div>
        <div id="modal-content" class="bg-white rounded-[2rem] shadow-2xl w-full max-w-sm z-10 overflow-hidden transform transition-all scale-95 opacity-0"></div>
    </div>

    <a href="https://docs.google.com/forms/d/e/1FAIpQLSeAn4-PCCxvCJxoHbXUDVCDMvl4m0ELLmURxCAjAE_SJoDKcQ/viewform" target="_blank" 
       class="fixed bottom-6 right-6 bg-[#bef264] text-slate-700 w-14 h-14 rounded-full shadow-lg flex items-center justify-center text-3xl hover:scale-110 transition-transform z-40 border-2 border-white">
        <span class="mb-1">+</span>
    </a>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbz8uRbvgYokCEfeK5LajVDBuSNn6ZnfmL1ZuCaF44nTmQ7PfL4OFVdecrdTRwXO6_8Y/exec";
        let allMembers = [];
        let favorites = JSON.parse(localStorage.getItem('homes_favs')) || [];
        let showOnlyFavs = false;

        const PART_COLORS = { "Vo": "text-pink-400", "Gt": "text-sky-400", "Ba": "text-indigo-400", "Dr": "text-emerald-400", "Key": "text-amber-400" };

        // 共通：パート表示HTML生成
        function getPartHTML(partStr) {
            return (partStr || "").split(/[/／、, ]/).map(p => {
                const trimmed = p.trim();
                if (!trimmed) return "";
                const colorClass = PART_COLORS[trimmed] || "text-[#65a30d]";
                return `<span class="${colorClass}">${trimmed}</span>`;
            }).filter(h => h).join('<span class="text-slate-300 mx-0.5">/</span>');
        }

        async function fetchMembers() {
            try {
                const response = await fetch(API_URL);
                allMembers = await response.json();
                updateList(); 
                document.getElementById('loading').classList.add('hidden');
            } catch (error) {
                document.getElementById('loading').innerHTML = `<p class="text-gray-400 font-bold">データを読み込めませんでした</p><button onclick="location.reload()" class="mt-4 px-6 py-2 bg-[#d9f99d] text-slate-700 rounded-full text-xs font-bold shadow-sm">再読み込み</button>`;
            }
        }

        function toggleFavorite(id) {
            const index = favorites.indexOf(id);
            if (index > -1) favorites.splice(index, 1);
            else favorites.push(id);
            localStorage.setItem('homes_favs', JSON.stringify(favorites));
            updateList();
        }

        function updateList() {
            const nameQuery = (document.getElementById('search-name').value || "").toLowerCase();
            const gradeQuery = document.getElementById('filter-grade').value;
            const partQuery = document.getElementById('filter-part').value;
            const statusQuery = document.getElementById('filter-status').value;

            const filtered = allMembers.filter(m => {
                const isFav = favorites.includes(m.id);
                const matchFav = !showOnlyFavs || isFav;
                const matchName = (m.name || "").toLowerCase().includes(nameQuery) || (m.comment || "").toLowerCase().includes(nameQuery);
                const matchGrade = gradeQuery === "" || String(m.grade) === gradeQuery;
                const matchPart = partQuery === "" || (m.part || "").includes(partQuery);
                const matchStatus = statusQuery === "" || (m.status || "").includes(statusQuery);
                return matchFav && matchName && matchGrade && matchPart && matchStatus;
            });
            renderMembers(filtered);
        }

        function renderMembers(members) {
            const listContainer = document.getElementById('member-list');
            listContainer.innerHTML = members.length === 0 ? `<p class="text-center text-gray-400 py-10 text-sm">該当するメンバーがいません</p>` : "";

            members.forEach((m, index) => {
                const isFav = favorites.includes(m.id);
                const cardBg = m.grade === "卒業生" ? "bg-slate-100" : "bg-white";
                const iconUrl = m.id ? `https://unavatar.io/twitter/${m.id}?fallback=https://ui-avatars.com/api/?name=${encodeURIComponent(m.name)}&background=f1f5f9&color=cbd5e1` : `https://ui-avatars.com/api/?name=${encodeURIComponent(m.name)}&background=f1f5f9&color=cbd5e1`;

                const card = document.createElement('div');
                card.className = `${cardBg} rounded-3xl shadow-[0_2px_15px_-3px_rgba(0,0,0,0.07)] p-5 flex items-center space-x-4 relative cursor-pointer hover:border-[#d9f99d] border border-transparent transition-all animate-fadeIn`;
                card.style.animationDelay = `${index * 0.03}s`;
                card.onclick = () => openModal(encodeURIComponent(JSON.stringify(m)));
        
                card.innerHTML = `
                    <div class="relative flex-shrink-0">
                        <img src="${iconUrl}" class="w-16 h-16 rounded-full bg-slate-100 object-cover border-2 border-white">
                        ${(m.status !== 'むり') ? '<span class="absolute -top-0.5 -right-0.5 h-3.5 w-3.5 rounded-full bg-lime-500 border-2 border-white"></span>' : ''}
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between items-start">
                            <h2 class="font-bold text-slate-700 truncate text-base">${m.name}</h2>
                            <button onclick="event.stopPropagation(); toggleFavorite('${m.id}')" class="p-1 focus:outline-none transition-transform active:scale-125">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 ${isFav ? 'fill-red-500 text-red-500 heart-pop' : 'text-gray-300'}" fill="${isFav ? 'currentColor' : 'none'}" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                                </svg>
                            </button>
                        </div>
                        <div class="flex items-center space-x-2 mt-0.5">
                            <div class="text-[13px] font-bold flex items-center flex-wrap">${getPartHTML(m.part)}</div>
                            <span class="text-[10px] text-slate-400 bg-slate-50 px-2 py-0.5 rounded-full border border-slate-100">${m.grade}${isNaN(m.grade) ? '' : '年'}</span>
                        </div>
                        <p class="text-[10px] font-bold text-orange-400 uppercase tracking-tighter mt-1">${m.status}</p>
                        <p class="text-[11px] text-slate-400 mt-1 line-clamp-1">${m.comment || ''}</p>
                    </div>`;
                listContainer.appendChild(card);
            });
        }

        // イベント設定
        document.getElementById('search-name').addEventListener('input', (e) => {
            document.getElementById('clear-btn').classList.toggle('hidden', e.target.value.length === 0);
            updateList();
        });
        document.getElementById('clear-btn').addEventListener('click', () => {
            const input = document.getElementById('search-name');
            input.value = '';
            document.getElementById('clear-btn').classList.add('hidden');
            updateList();
            input.focus();
        });
        document.getElementById('filter-grade').addEventListener('change', updateList);
        document.getElementById('filter-part').addEventListener('change', updateList);
        document.getElementById('filter-status').addEventListener('change', updateList);
        document.getElementById('filter-fav').addEventListener('click', function() {
            showOnlyFavs = !showOnlyFavs;
            this.classList.toggle('bg-red-50'); this.classList.toggle('text-red-500'); this.classList.toggle('border-red-200');
            updateList();
        });

        function openModal(memberJson) {
            const m = JSON.parse(decodeURIComponent(memberJson));
            const modal = document.getElementById('detail-modal');
            const content = document.getElementById('modal-content');
            const iconUrl = m.id ? `https://unavatar.io/twitter/${m.id}` : `https://ui-avatars.com/api/?name=${m.name}`;

            content.innerHTML = `
                <div class="p-8 text-center">
                    <img src="${iconUrl}" class="w-24 h-24 rounded-full mx-auto border-4 border-white shadow-lg mb-4">
                    <h2 class="text-2xl font-bold text-slate-700 mb-1">${m.name}</h2>
                    <div class="flex items-center justify-center space-x-2 mb-4">
                        <div class="font-bold">${getPartHTML(m.part)}</div>
                        <span class="text-xs text-slate-400 bg-slate-100 px-2 py-0.5 rounded-full">${m.grade}${isNaN(m.grade) ? '' : '年'}</span>
                    </div>
                    <div class="bg-slate-50 rounded-2xl p-6 text-left mb-6">
                        <p class="text-[10px] font-bold text-orange-400 uppercase mb-2">STATUS: ${m.status}</p>
                        <p class="text-slate-600 text-sm leading-relaxed whitespace-pre-wrap">${m.comment || '（コメントなし）'}</p>
                    </div>
                    <div class="flex flex-col space-y-3">
                        <a href="https://twitter.com/${m.id}" target="_blank" class="w-full py-4 bg-slate-800 text-white rounded-2xl font-bold text-sm">X (Twitter) を見る</a>
                        <button onclick="closeModal()" class="w-full py-4 text-slate-400 font-bold text-sm">とじる</button>
                    </div>
                </div>`;
            modal.classList.remove('hidden');
            setTimeout(() => { content.classList.remove('scale-95', 'opacity-0'); content.classList.add('scale-100', 'opacity-100'); }, 10);
        }

        function closeModal() {
            const content = document.getElementById('modal-content');
            content.classList.add('scale-95', 'opacity-0');
            setTimeout(() => { document.getElementById('detail-modal').classList.add('hidden'); }, 200);
        }

        // プルリフレッシュ処理
        let startY = 0;
        const pullIndicator = document.getElementById('pull-indicator');
        window.addEventListener('touchstart', (e) => { startY = window.scrollY === 0 ? e.touches[0].pageY : null; }, { passive: true });
        window.addEventListener('touchmove', (e) => {
            if (startY === null || window.scrollY > 0) return;
            const diff = e.touches[0].pageY - startY;
            if (diff > 0) {
                pullIndicator.style.height = `${Math.min(diff, 100)}px`;
                pullIndicator.style.opacity = diff / 80;
            }
        }, { passive: true });
        window.addEventListener('touchend', async () => {
            if (startY !== null && parseInt(pullIndicator.style.height) >= 80) await fetchMembers();
            pullIndicator.style.height = '0px'; pullIndicator.style.opacity = '0';
        });

        fetchMembers();
    </script>
</body>
</html>